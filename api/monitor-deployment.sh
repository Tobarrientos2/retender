#!/bin/bash

# Script para monitorear el deployment de Koyeb
set -e

APP_NAME="transcription-api"
SERVICE_NAME="api"
KOYEB_CLI="$HOME/.koyeb/bin/koyeb"

echo "üîç Monitoreando deployment de $APP_NAME/$SERVICE_NAME"
echo "=================================================="

# Funci√≥n para obtener el estado
get_status() {
    $KOYEB_CLI services get $APP_NAME/$SERVICE_NAME --output json 2>/dev/null | jq -r '.status // "unknown"'
}

# Funci√≥n para obtener la URL p√∫blica
get_public_url() {
    $KOYEB_CLI services get $APP_NAME/$SERVICE_NAME --output json 2>/dev/null | jq -r '.public_url // "pending"'
}

# Monitorear hasta que est√© listo
TIMEOUT=600  # 10 minutos
ELAPSED=0
INTERVAL=15

echo "‚è≥ Esperando que el deployment complete..."
echo "   Timeout: ${TIMEOUT}s"
echo "   Intervalo de verificaci√≥n: ${INTERVAL}s"
echo ""

while [ $ELAPSED -lt $TIMEOUT ]; do
    STATUS=$(get_status)
    PUBLIC_URL=$(get_public_url)
    
    echo "[$(date '+%H:%M:%S')] Status: $STATUS | URL: $PUBLIC_URL | Tiempo: ${ELAPSED}s"
    
    case $STATUS in
        "healthy")
            echo ""
            echo "‚úÖ ¬°Deployment completado exitosamente!"
            echo "=================================="
            echo "üåê URL p√∫blica: $PUBLIC_URL"
            echo "üìö Documentaci√≥n: $PUBLIC_URL/docs"
            echo "‚ù§Ô∏è Health check: $PUBLIC_URL/health"
            echo "üîå WebSocket: wss://${PUBLIC_URL#https://}/ws/transcription/{job_id}"
            echo ""
            
            # Probar health check
            echo "üß™ Probando health check..."
            if curl -s "$PUBLIC_URL/health" > /dev/null; then
                echo "‚úÖ Health check exitoso"
            else
                echo "‚ö†Ô∏è Health check fall√≥, pero el servicio est√° marcado como healthy"
            fi
            
            echo ""
            echo "üìã Comandos √∫tiles:"
            echo "  Ver logs:     $KOYEB_CLI services logs $APP_NAME/$SERVICE_NAME"
            echo "  Ver status:   $KOYEB_CLI services get $APP_NAME/$SERVICE_NAME"
            echo "  Redeploy:     $KOYEB_CLI services redeploy $APP_NAME/$SERVICE_NAME"
            echo ""
            echo "üéâ ¬°Tu API est√° lista para usar!"
            exit 0
            ;;
        "error"|"unhealthy")
            echo ""
            echo "‚ùå Deployment fall√≥ con status: $STATUS"
            echo "üìã √öltimos logs:"
            $KOYEB_CLI services logs $APP_NAME/$SERVICE_NAME --tail 20
            echo ""
            echo "üí° Revisa los logs completos en: https://app.koyeb.com/apps/$APP_NAME"
            exit 1
            ;;
        "starting"|"building"|"deploying")
            # Estados normales durante deployment
            ;;
        *)
            echo "‚ö†Ô∏è Estado desconocido: $STATUS"
            ;;
    esac
    
    sleep $INTERVAL
    ELAPSED=$((ELAPSED + INTERVAL))
done

echo ""
echo "‚è∞ Timeout alcanzado despu√©s de ${TIMEOUT}s"
echo "üìã Estado final:"
$KOYEB_CLI services get $APP_NAME/$SERVICE_NAME
echo ""
echo "üí° El deployment puede seguir en progreso. Revisa en:"
echo "üåê https://app.koyeb.com/apps/$APP_NAME"
exit 1
